#!/usr/bin/env ruby
# git-boot

# 20100310
# 0.3.0

# Discussion: 
# There's a problem with using Ruby's standard URI library for SSH-style network descriptors...  

# With neither protocol, nor colons:
# uri1 = 'git@git.example.com/usr/local/git_repos/blah.git'
# URI.parse(uri1).path
# => "git@git.example.com/usr/local/git_repos/blah.git"

# With a protocol and without colons:
# uri2 = 'git://git@git.example.com/usr/local/git_repos/blah.git'
# URI.parse(uri2).path
# => "/usr/local/git_repos/blah.git"

# With a protocol and with a colon:
# uri3 = 'git://git@git.example.com:/usr/local/git_repos/blah.git'
# URI.parse(uri3).path
# => "/usr/local/git_repos/blah.git"

# With no protocol and a colon:
# uri4 = 'git@git.example.com:/usr/local/git_repos/blah.git'
# URI.parse(uri4).path
# =>
# URI::InvalidURIError: bad URI(is not URI?): git@git.example.com:/usr/local/git_repos/blah.git
# 	from /opt/local/lib/ruby/1.8/uri/common.rb:436:in `split'
# 	from /opt/local/lib/ruby/1.8/uri/common.rb:485:in `parse'

# So, my solution is to add a protocol and to strip colons, since this seems to be the easiest way to get this to work for a reasonable number of options...  

# Unfortunately, I also need the SSH-style network identifier as well for the locally-issued commands.  

require 'fileutils'
require 'uri'

require 'net/ssh/shell'

require 'Switches'

def path_to_repository_with_extension(uri)
  path = URI.parse(normalised_uri(uri)).path
  path =~ /\.git$/ ? path : path + '.git'
end

def normalised_uri(uri)
  uri_with_protocol(uri_without_colon(uri))
end

def uri_with_protocol(uri)
  uri =~ /^[a-z]*?:\/\// ? uri : 'git://' + uri
end

def uri_without_colon(uri)
  uri.gsub(':','')
end

def uri_with_colon(uri)
  path = path_to_repository_with_extension(uri)
  hostname = URI.parse(normalised_uri(uri)).host
  protocol = URI.parse(normalised_uri(uri)).scheme
  username = URI.parse(normalised_uri(uri)).user
  "#{protocol}://#{username}@#{hostname}:#{path}"
end

def uri_without_protocol(uri)
  uri.gsub(/^[a-z]*?:\/\//, '')
end

def ssh_style_uri(uri)
  uri_without_protocol(uri_with_colon(uri))
end

def do_remote_repo(switches)
  Net::SSH.start(URI.parse(normalised_uri(switches.uri)).host, switches.username, :password => switches.password) do |ssh|
    ssh.shell do |sh|
      sh.execute "mkdir #{path_to_repository_with_extension(switches.uri)}"
      sh.execute "cd #{path_to_repository_with_extension(switches.uri)}"
      sh.execute "git init"
      sh.execute "exit"
    end
  end
end

def do_local_repo
  system "git init" unless File.exist?('.git')
  if !Dir['*'].empty?
    system "git add ."
    system "git commit -m '+ *'"
  else
    FileUtils.touch('.gitignore')
    system "git add .gitignore"
    system "git commit -m '+ .gitignore'"
  end
end

def do_push_to_remote(switches)
  system "git remote add origin #{ssh_style_uri(switches.uri)}"
  system "git push origin master"
end

def main
  switches = Switches.new do |s|
    s.optional!(:u, :user, :username)
    s.optional!(:p, :pwd, :pass, :password)
    s.optional!(:uri, :url)
  end
  do_local_repo
  if switches.u && switches.p && switches.uri
    do_remote_repo(switches)
    do_push_to_remote(switches)
  end
end

main
