# git-mkremote

# 20100310
# 0.1.1

require 'fileutils'
require 'uri'

require 'net/ssh/shell'

require 'Switches'

def path_to_repository_with_ext(uri)
  path = URI.parse(uri_with_protocol(uri))
  path =~ /\.git$/ ? path : path + '.git'
end

def uri_with_protocol(uri)
  uri =~ /^[a-z]*?:\/\// ? uri : 'git://' + uri
end

def do_remote(switches)
  Net::SSH.start(URI.parse(uri_with_protocol(switches.uri)).host, switches.username, :password => switches.password) do |ssh|
    ssh.shell do |sh|
      sh.execute "mkdir #{path_to_repository_with_ext(switches.uri)}"
      sh.execute "cd #{path_to_repository_with_ext(switches.uri)}"
      sh.execute "git init"
      sh.execute "exit"
    end
  end
end

def do_local(switches)
  system "git remote add origin #{switches.uri}"
  system "git push origin master"
end

def main
  switches = Switches.new do |s|
    s.set(:u, :user, :username)
    s.set(:p, :pwd, :pass, :password)
    s.set(:uri, :url)
  end
  do_remote(switches)
  do_local(switches)
end

main
