#!/usr/bin/env ruby
# git-boot

# 20120402, 03
# 0.6.0

require 'fileutils'
require 'HTTP'
require 'ImpURI.rbd/ImpURI'
require 'net/ssh/shell'

include HTTP

def path_to_repository_with_extension(impuri)
  impuri.path =~ /\.git$/ ? impuri.path : impuri.path + '.git'
end

def create_local_repo
  system "git init" unless File.exist?('.git')
  if !Dir['*'].empty?
    system "git add ."
    system "git commit -m '+ *'"
  else
    FileUtils.touch('.gitignore')
    system "git add .gitignore"
    system "git commit -m '+ .gitignore'"
  end
end

def create_remote_repo(impuri)
  Net::SSH.start(impuri.host, impuri.username, :password => impuri.password) do |ssh|
    ssh.shell do |sh|
      sh.execute "mkdir #{path_to_repository_with_extension(impuri)}"
      sh.execute "cd #{path_to_repository_with_extension(impuri)}"
      sh.execute "git --bare init"
      sh.execute "exit"
    end
  end
end

def create_remote_github_repo(impuri)
  post('https://github.com/api/v2/json/repos/create', {:login => impuri.username, :token => impuri.password, :name => File.basename(impuri.path)})
end

def push_to_remote_repo(impuri)
  ssh_style_uri = "#{impuri.username}@#{impuri.hostname}:#{impuri.path}"
  system "git remote add origin #{ssh_style_uri}"
  system "git push origin master"
end

def main
  impuri = ImpURI.new(ARGV[0])
  create_local_repo
  if impuri
    if impuri.hostname == 'github.com'
      create_remote_github_repo(impuri)
    else 
      create_remote_repo(impuri)
    end
    push_to_remote_repo(impuri)
  end
end

main
